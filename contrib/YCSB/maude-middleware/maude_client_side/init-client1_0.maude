load ramp-f

mod INIT-CLIENT is
  inc RAMP-F .
  inc SHIM-DYNAMIC .


  vars O O' : Oid .
  vars N' N : Nat .
  vars STR KR : String .
  var RT : ReplicaTable .

  ---(
  *** post load
 crl < O : Table | table : RT >
     [KR,O']
   => 
     < O : Table | table : addKeyReplica(KR,RT) >
     if N := find(KR,"[eoa]",0) .

  op addKeyReplica : String ReplicaTable -> ReplicaTable .
 ceq addKeyReplica(KR,RT) = addKeyReplica(substr(STR,N' + 5,length(STR)),insert(substr(KR,0,N),substr(STR,0,N'),RT))
       if N := find(KR, "[eok]", 0) /\ 
        STR := substr(KR, N + 5, length(KR)) /\
         N' := find(STR, "[eoa]", 0) .
  eq addKeyReplica("",RT) = RT .
  )

  ops tb m : -> Oid .

  op self : -> String .
  eq port = 9000 .  *** the base port for client talking to server
  eq backLog = 1 .  *** the BACKLOG parameter on the server side
  op clientId : -> Nat .

  *** Newly added for separating YCSB
  op initTable : -> ReplicaTable .
  op initSqn : -> Nat .
  op initTxns : -> ObjList .


  ***START AUTOMATICALLY GENERATED PARAMETER CODE***
  eq self = "155.98.36.65" .
  eq numberOfServerSockets = 0 . *** one for post-load, one for txns
  eq clientId = 0 .

  eq initTable = ( "user55" |-> "155.98.36.130", "user54" |-> "155.98.36.130", "user1445" |-> "155.98.36.130", "user53" |-> "155.98.36.130", "user1444" |-> "155.98.36.130", "user52" |-> "155.98.36.130", "user48" |-> "155.98.36.130", "user1450" |-> "155.98.36.130", "user57" |-> "155.98.36.130", "user1452" |-> "155.98.36.130", "user1451" |-> "155.98.36.130", "user56" |-> "155.98.36.130", "user51" |-> "155.98.36.130", "user50" |-> "155.98.36.130", "user49" |-> "155.98.36.130", "user1447" |-> "155.98.36.130", "user1446" |-> "155.98.36.130", "user1449" |-> "155.98.36.130", "user1448" |-> "155.98.36.130", "user55" |-> "155.98.36.63", "user1574" |-> "155.98.36.63", "user53" |-> "155.98.36.63", "user1576" |-> "155.98.36.63", "user48" |-> "155.98.36.63", "user1570" |-> "155.98.36.63", "user57" |-> "155.98.36.63", "user1572" |-> "155.98.36.63", "user1568" |-> "155.98.36.63", "user50" |-> "155.98.36.63", "user1575" |-> "155.98.36.123", "user54" |-> "155.98.36.123", "user52" |-> "155.98.36.123", "user1571" |-> "155.98.36.123", "user1573" |-> "155.98.36.123", "user56" |-> "155.98.36.123", "user49" |-> "155.98.36.123", "user51" |-> "155.98.36.123", "user1567" |-> "155.98.36.123", "user1569" |-> "155.98.36.123", "user55" |-> "155.98.36.63", "user1574" |-> "155.98.36.63", "user53" |-> "155.98.36.63", "user1576" |-> "155.98.36.63", "user48" |-> "155.98.36.63", "user1570" |-> "155.98.36.63", "user57" |-> "155.98.36.63", "user1572" |-> "155.98.36.63", "user1568" |-> "155.98.36.63", "user50" |-> "155.98.36.63", "user1575" |-> "155.98.36.123", "user54" |-> "155.98.36.123", "user52" |-> "155.98.36.123", "user1571" |-> "155.98.36.123", "user1573" |-> "155.98.36.123", "user56" |-> "155.98.36.123", "user49" |-> "155.98.36.123", "user51" |-> "155.98.36.123", "user1567" |-> "155.98.36.123", "user1569" |-> "155.98.36.123" ) .
  eq initSqn = 100 .
  eq initTxns = ( < tid(l(self,clientId),1) : Txn | operations : write("user48","/;") write("user50","$("), latest : empty, txnSqn : 1, readSet : empty > ;; < tid(l(self,clientId),2) : Txn | operations : write("user53","(7") write("user48","!6"), latest : empty, txnSqn : 2, readSet : empty > ;; < tid(l(self,clientId),3) : Txn | operations : write("user48",">)") write("user1447","2("), latest : empty, txnSqn : 3, readSet : empty > ;; < tid(l(self,clientId),4) : Txn | operations : write("user50","$7") write("user1448",",?"), latest : empty, txnSqn : 4, readSet : empty > ;; < tid(l(self,clientId),5) : Txn | operations : write("user55","<5") write("user48","*&"), latest : empty, txnSqn : 5, readSet : empty > ;; < tid(l(self,clientId),6) : Txn | operations : write("user49","$$") write("user50",">?"), latest : empty, txnSqn : 6, readSet : empty > ;; < tid(l(self,clientId),7) : Txn | operations : write("user48","1/") write("user49","<<"), latest : empty, txnSqn : 7, readSet : empty > ;; < tid(l(self,clientId),8) : Txn | operations : write("user54",";)") write("user1444","9!"), latest : empty, txnSqn : 8, readSet : empty > ;; < tid(l(self,clientId),9) : Txn | operations : write("user48","0<") write("user49","&8"), latest : empty, txnSqn : 9, readSet : empty > ;; < tid(l(self,clientId),10) : Txn | operations : write("user1444",",$") write("user48","+0"), latest : empty, txnSqn : 10, readSet : empty > ;; < tid(l(self,clientId),11) : Txn | operations : write("user56","0/") write("user1449","9$"), latest : empty, txnSqn : 11, readSet : empty > ;; < tid(l(self,clientId),12) : Txn | operations : write("user48","?=") write("user51","0:"), latest : empty, txnSqn : 12, readSet : empty > ;; < tid(l(self,clientId),13) : Txn | operations : write("user55","3<") write("user52","6#"), latest : empty, txnSqn : 13, readSet : empty > ;; < tid(l(self,clientId),14) : Txn | operations : write("user55","$&") write("user56","67"), latest : empty, txnSqn : 14, readSet : empty > ;; < tid(l(self,clientId),15) : Txn | operations : write("user52","7:") write("user50","60"), latest : empty, txnSqn : 15, readSet : empty > ;; < tid(l(self,clientId),16) : Txn | operations : write("user52","%<") write("user56","#!"), latest : empty, txnSqn : 16, readSet : empty > ;; < tid(l(self,clientId),17) : Txn | operations : write("user48","1$") write("user1447","7+"), latest : empty, txnSqn : 17, readSet : empty > ;; < tid(l(self,clientId),18) : Txn | operations : write("user55",">8") write("user56","/0"), latest : empty, txnSqn : 18, readSet : empty > ;; < tid(l(self,clientId),19) : Txn | operations : write("user54",">*") write("user57","&$"), latest : empty, txnSqn : 19, readSet : empty > ;; < tid(l(self,clientId),20) : Txn | operations : write("user54","7+") write("user48","4*"), latest : empty, txnSqn : 20, readSet : empty > ;; < tid(l(self,clientId),21) : Txn | operations : write("user49","*4") write("user1448","65"), latest : empty, txnSqn : 21, readSet : empty > ;; < tid(l(self,clientId),22) : Txn | operations : write("user1450","$?") write("user49","<$"), latest : empty, txnSqn : 22, readSet : empty > ;; < tid(l(self,clientId),23) : Txn | operations : write("user55","(:") write("user1444","/>"), latest : empty, txnSqn : 23, readSet : empty > ;; < tid(l(self,clientId),24) : Txn | operations : write("user1445","$8") write("user56","!$"), latest : empty, txnSqn : 24, readSet : empty > ;; < tid(l(self,clientId),25) : Txn | operations : write("user48","<8") write("user1448","=!"), latest : empty, txnSqn : 25, readSet : empty > ;; < tid(l(self,clientId),26) : Txn | operations : write("user51","7;") write("user1447","$2"), latest : empty, txnSqn : 26, readSet : empty > ;; < tid(l(self,clientId),27) : Txn | operations : write("user55",";7") write("user51","5%"), latest : empty, txnSqn : 27, readSet : empty > ;; < tid(l(self,clientId),28) : Txn | operations : write("user54",";!") write("user48","9$"), latest : empty, txnSqn : 28, readSet : empty > ;; < tid(l(self,clientId),29) : Txn | operations : write("user55","5>") write("user54","(%"), latest : empty, txnSqn : 29, readSet : empty > ;; < tid(l(self,clientId),30) : Txn | operations : write("user52",")-") write("user49","?!"), latest : empty, txnSqn : 30, readSet : empty > ;; < tid(l(self,clientId),31) : Txn | operations : write("user57",">+") write("user51","<$"), latest : empty, txnSqn : 31, readSet : empty > ;; < tid(l(self,clientId),32) : Txn | operations : write("user52","#<") write("user56","+>"), latest : empty, txnSqn : 32, readSet : empty > ;; < tid(l(self,clientId),33) : Txn | operations : write("user48",",$") write("user57","+$"), latest : empty, txnSqn : 33, readSet : empty > ;; < tid(l(self,clientId),34) : Txn | operations : write("user57","-3") write("user1452","$1"), latest : empty, txnSqn : 34, readSet : empty > ;; < tid(l(self,clientId),35) : Txn | operations : write("user48","1/") write("user1448",".*"), latest : empty, txnSqn : 35, readSet : empty > ;; < tid(l(self,clientId),36) : Txn | operations : write("user55","2+") write("user49","&$"), latest : empty, txnSqn : 36, readSet : empty > ;; < tid(l(self,clientId),37) : Txn | operations : write("user52",",1") write("user1451","%'"), latest : empty, txnSqn : 37, readSet : empty > ;; < tid(l(self,clientId),38) : Txn | operations : write("user1444","?;") write("user52","!,"), latest : empty, txnSqn : 38, readSet : empty > ;; < tid(l(self,clientId),39) : Txn | operations : write("user1444","6$") write("user1452","2%"), latest : empty, txnSqn : 39, readSet : empty > ;; < tid(l(self,clientId),40) : Txn | operations : write("user56","%'") write("user51","8#"), latest : empty, txnSqn : 40, readSet : empty > ;; < tid(l(self,clientId),41) : Txn | operations : write("user57","?*") write("user51","5+"), latest : empty, txnSqn : 41, readSet : empty > ;; < tid(l(self,clientId),42) : Txn | operations : write("user48","%)") write("user50",":&"), latest : empty, txnSqn : 42, readSet : empty > ;; < tid(l(self,clientId),43) : Txn | operations : write("user48","?#") write("user1448","$;"), latest : empty, txnSqn : 43, readSet : empty > ;; < tid(l(self,clientId),44) : Txn | operations : write("user52","28") write("user48","67"), latest : empty, txnSqn : 44, readSet : empty > ;; < tid(l(self,clientId),45) : Txn | operations : write("user54","91") write("user1448","1$"), latest : empty, txnSqn : 45, readSet : empty > ;; < tid(l(self,clientId),46) : Txn | operations : write("user54","$)") write("user57","8%"), latest : empty, txnSqn : 46, readSet : empty > ;; < tid(l(self,clientId),47) : Txn | operations : write("user56",":&") write("user1449","58"), latest : empty, txnSqn : 47, readSet : empty > ;; < tid(l(self,clientId),48) : Txn | operations : write("user52","$8") write("user49","$("), latest : empty, txnSqn : 48, readSet : empty > ;; < tid(l(self,clientId),49) : Txn | operations : write("user57","1%") write("user49","1<"), latest : empty, txnSqn : 49, readSet : empty > ;; < tid(l(self,clientId),50) : Txn | operations : write("user49","$6") write("user1446","8<"), latest : empty, txnSqn : 50, readSet : empty > ;; < tid(l(self,clientId),51) : Txn | operations : write("user54","$*") write("user57","*)"), latest : empty, txnSqn : 51, readSet : empty > ;; < tid(l(self,clientId),52) : Txn | operations : write("user48",",6") write("user56","6!"), latest : empty, txnSqn : 52, readSet : empty > ;; < tid(l(self,clientId),53) : Txn | operations : write("user49","<<") write("user1447",">;"), latest : empty, txnSqn : 53, readSet : empty > ;; < tid(l(self,clientId),54) : Txn | operations : write("user55","5$") write("user57","(0"), latest : empty, txnSqn : 54, readSet : empty > ;; < tid(l(self,clientId),55) : Txn | operations : write("user57","'4") write("user50","//"), latest : empty, txnSqn : 55, readSet : empty > ;; < tid(l(self,clientId),56) : Txn | operations : write("user52","?>") write("user1447","81"), latest : empty, txnSqn : 56, readSet : empty > ;; < tid(l(self,clientId),57) : Txn | operations : write("user57","$,") write("user49","87"), latest : empty, txnSqn : 57, readSet : empty > ;; < tid(l(self,clientId),58) : Txn | operations : write("user55",",$") write("user56","-3"), latest : empty, txnSqn : 58, readSet : empty > ;; < tid(l(self,clientId),59) : Txn | operations : write("user49","6#") write("user1447","(,"), latest : empty, txnSqn : 59, readSet : empty > ;; < tid(l(self,clientId),60) : Txn | operations : write("user54","85") write("user56","*#"), latest : empty, txnSqn : 60, readSet : empty > ;; < tid(l(self,clientId),61) : Txn | operations : write("user52","?,") write("user56","$-"), latest : empty, txnSqn : 61, readSet : empty > ;; < tid(l(self,clientId),62) : Txn | operations : write("user53","//") write("user57","47"), latest : empty, txnSqn : 62, readSet : empty > ;; < tid(l(self,clientId),63) : Txn | operations : write("user54","#4") write("user1450","88"), latest : empty, txnSqn : 63, readSet : empty > ;; < tid(l(self,clientId),64) : Txn | operations : write("user1444",">7") write("user50","+*"), latest : empty, txnSqn : 64, readSet : empty > ;; < tid(l(self,clientId),65) : Txn | operations : write("user57","$!") write("user1448","?,"), latest : empty, txnSqn : 65, readSet : empty > ;; < tid(l(self,clientId),66) : Txn | operations : write("user54","!#") write("user57","66"), latest : empty, txnSqn : 66, readSet : empty > ;; < tid(l(self,clientId),67) : Txn | operations : write("user53","3*") write("user56","36"), latest : empty, txnSqn : 67, readSet : empty > ;; < tid(l(self,clientId),68) : Txn | operations : write("user57","?/") write("user50",";-"), latest : empty, txnSqn : 68, readSet : empty > ;; < tid(l(self,clientId),69) : Txn | operations : write("user1445","!,") write("user57","5!"), latest : empty, txnSqn : 69, readSet : empty > ;; < tid(l(self,clientId),70) : Txn | operations : write("user54","#(") write("user57","8."), latest : empty, txnSqn : 70, readSet : empty > ;; < tid(l(self,clientId),71) : Txn | operations : write("user56","-$") write("user50","'$"), latest : empty, txnSqn : 71, readSet : empty > ;; < tid(l(self,clientId),72) : Txn | operations : write("user56",",5") write("user1446",".7"), latest : empty, txnSqn : 72, readSet : empty > ;; < tid(l(self,clientId),73) : Txn | operations : write("user1444","8>") write("user48","$4"), latest : empty, txnSqn : 73, readSet : empty > ;; < tid(l(self,clientId),74) : Txn | operations : write("user48","=8") write("user57","/6"), latest : empty, txnSqn : 74, readSet : empty > ;; < tid(l(self,clientId),75) : Txn | operations : write("user57","9$") write("user51","(2"), latest : empty, txnSqn : 75, readSet : empty > ;; < tid(l(self,clientId),76) : Txn | operations : write("user52","<)") write("user50","&4"), latest : empty, txnSqn : 76, readSet : empty > ;; < tid(l(self,clientId),77) : Txn | operations : write("user53","$2") write("user52","-!"), latest : empty, txnSqn : 77, readSet : empty > ;; < tid(l(self,clientId),78) : Txn | operations : write("user48","6!") write("user57",",."), latest : empty, txnSqn : 78, readSet : empty > ;; < tid(l(self,clientId),79) : Txn | operations : write("user56","+!") write("user1449",":>"), latest : empty, txnSqn : 79, readSet : empty > ;; < tid(l(self,clientId),80) : Txn | operations : write("user57","/7") write("user56","=$"), latest : empty, txnSqn : 80, readSet : empty > ;; < tid(l(self,clientId),81) : Txn | operations : write("user1450","##") write("user56","!>"), latest : empty, txnSqn : 81, readSet : empty > ;; < tid(l(self,clientId),82) : Txn | operations : write("user52","*#") write("user51","/>"), latest : empty, txnSqn : 82, readSet : empty > ;; < tid(l(self,clientId),83) : Txn | operations : write("user51","!)") write("user50",";."), latest : empty, txnSqn : 83, readSet : empty > ;; < tid(l(self,clientId),84) : Txn | operations : write("user54","/&") write("user56","%("), latest : empty, txnSqn : 84, readSet : empty > ;; < tid(l(self,clientId),85) : Txn | operations : write("user1445","83") write("user1444","$6"), latest : empty, txnSqn : 85, readSet : empty > ;; < tid(l(self,clientId),86) : Txn | operations : write("user1451","(7") write("user56","$2"), latest : empty, txnSqn : 86, readSet : empty > ;; < tid(l(self,clientId),87) : Txn | operations : write("user54","=&") write("user48","$!"), latest : empty, txnSqn : 87, readSet : empty > ;; < tid(l(self,clientId),88) : Txn | operations : write("user48","%5") write("user56","-$"), latest : empty, txnSqn : 88, readSet : empty > ;; < tid(l(self,clientId),89) : Txn | operations : write("user1445","7?") write("user1448","27"), latest : empty, txnSqn : 89, readSet : empty > ;; < tid(l(self,clientId),90) : Txn | operations : write("user1452","?;") write("user1448","-+"), latest : empty, txnSqn : 90, readSet : empty > ;; < tid(l(self,clientId),91) : Txn | operations : write("user51","&.") write("user50","#*"), latest : empty, txnSqn : 91, readSet : empty > ;; < tid(l(self,clientId),92) : Txn | operations : write("user55","/&") write("user56","2/"), latest : empty, txnSqn : 92, readSet : empty > ;; < tid(l(self,clientId),93) : Txn | operations : write("user57","6<") write("user1449","52"), latest : empty, txnSqn : 93, readSet : empty > ;; < tid(l(self,clientId),94) : Txn | operations : write("user57","//") write("user1448",".)"), latest : empty, txnSqn : 94, readSet : empty > ;; < tid(l(self,clientId),95) : Txn | operations : write("user1447","5#") write("user1448",">("), latest : empty, txnSqn : 95, readSet : empty > ;; < tid(l(self,clientId),96) : Txn | operations : write("user52","><") write("user1447","='"), latest : empty, txnSqn : 96, readSet : empty > ;; < tid(l(self,clientId),97) : Txn | operations : write("user55",",:") write("user56","7:"), latest : empty, txnSqn : 97, readSet : empty > ;; < tid(l(self,clientId),98) : Txn | operations : write("user52","4<") write("user50","91"), latest : empty, txnSqn : 98, readSet : empty > ;; < tid(l(self,clientId),99) : Txn | operations : write("user54","!>") write("user57","06"), latest : empty, txnSqn : 99, readSet : empty > ;; < tid(l(self,clientId),100) : Txn | operations : write("user52","=5") write("user1448","+!"), latest : empty, txnSqn : 100, readSet : empty > ) .
  ***END AUTOMATICALLY GENERATED PARAMETER CODE***

  op init : -> Configuration .
  eq init = <>
            < l(self,10000) : ClientShim | sockets : none, contacts : empty, bufferedMsgs : none >
            < l(self,10001) : ServerShim | sockets : none, contacts : empty, bufferedMsgs : none, created : 0 >

            < l(self,clientId) : Client | txns : initTxns, sqn : initSqn,
                                   executing : none, committed : none, 
                                   1stGetSites : no1st, 2ndGetSites : no2nd,
                                   voteSites : noVS, commitSites : noVS > 

            < tb : Table | table : initTable >

            < m : Monitor | count : 0 >

	    ***START AUTOMATICALLY GENERATED SOCKET CODE***
            ***createServerTcpSocket(socketManager, l(self,clientId), 9810, 10)  *** opened for post-load
            ***createServerTcpSocket(socketManager, l(self,clientId), 9910, 10)  *** opened for txns
	    ***END AUTOMATICALLY GENERATED SOCKET CODE***
        .

  --- local test
  ---(
  eq init = ---<>
            ---< l(self,10000) : ClientShim | sockets : none, contacts : empty, bufferedMsgs : none >
            ---< l(self,10001) : ServerShim | sockets : none, contacts : empty, bufferedMsgs : none, created : 0 >

            *** l(self,0) when deployed
            < l(self) : Client | txns : emptyTxnList, sqn : 0,
                                 executing : none, committed : none, 
                                 1stGetSites : no1st, 2ndGetSites : no2nd,
                                 voteSites : noVS, commitSites : noVS > 

            < l(addr1) : Replica | datastore : empty, latestCommit : empty >

            < tb : Table | table : "k0" |-> addr1, "k1" |-> addr1 >

            < m : Monitor | count : 0 >

            ["k0[eok]v0[eov]k1[eok]v1[eov]",l(self)]  
            ["k0[eor]k1[eor]",l(self)] .  *** l(self,0) when deployed
  )
endm

---rew init .
erew init .
